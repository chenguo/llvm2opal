#! /usr/bin/env perl

# USAGE:
# $ insert_function INFILE FUNCTION...
# This script will look in the INFILE for the function dx_sethi, and locate
# the else statement in the if-else chain contained in it. It then parses
# each FUNCTION file for functions generated by llvm2opal (with the -o
# option, so there is an opcode) and insert them into dx_sethi as an
# else if statemnt.

open (my $in, "<", $ARGV[0]) || die ("Failed to open input file: $!");

my $step = 0;

while (<$in>)
  {
    # Locat dx_set.
    if ($step == 0 && $_ =~ /dx_sethi/)
      {
        $step = 1;
      }
    # Locate last else statement.
    elsif ($step == 1 && $_ =~ /else {/)
      {
        $step = 2;
        $save = $_;
        for ($i = 1; $i <= $#ARGV; $i++)
          {
            ins_file ($ARGV[$i]);
          }
        print $save;
      }
    print $_;
  }


sub ins_file {
  my $file = shift;
  open (my $src, "<", $file) || die ("Failed to open input file: $!");

  $first_func = 1;

  while (<$src>)
    {
      if ($_ =~ /OPCODE /)
        {
          # Print a closing bracket for previous function, if needed.
          if ($first_func)
            {
              $first_func = 0;
            }
          else
            {
              print "  }\n";
            }
          $_ =~ s/OPCODE (.*)\n/$1/g;
          print "  else if (op==$_)\n";
          print "  {\n";
        }
      elsif ($_ !~ /^\n/)
        {
          $_ =~ s/^\s*/	/g; 
          print $_;
        }
    }
  # Print last closing bracket.
  print "  }\n";
}
